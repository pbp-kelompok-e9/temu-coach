{% extends 'base.html' %}
{% load static %} {# Jika perlu static files lain #}

{% block title %}Dashboard Anda{% endblock %}

{# Hapus block content_style jika tidak ada CSS custom tambahan #}

{% block content %}
<div class="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8"> {# ≈ dashboard-container #}
    <h1 class="text-4xl font-bold text-primary-blue mb-10">Janji Temu Anda</h1>

    <section class="mb-12"> {# ≈ booking-section #}
        <h2 class="text-2xl font-bold text-primary-orange mb-6 pb-2 border-b border-gray-300"> {# ≈ section-title #}
            Mendatang
        </h2>
        
        {% for booking in upcoming_bookings %}
        {# ≈ booking-card upcoming-card #}
        <div class="bg-white rounded-xl shadow-md flex flex-col sm:flex-row items-start gap-4 p-6 mb-6 border-l-4 border-primary-blue relative"> 
            
            <div class="flex-grow w-full"> {# ≈ booking-info #}
                {# ≈ coach-name #}
                <h3 class="text-xl font-bold text-gray-900 mb-1">{{ booking.jadwal.coach.name }}</h3> 
                {# ≈ booking-time #}
                <p class="text-base font-semibold text-primary-blue mb-3">
                    {{ booking.jadwal.tanggal|date:"l, j F Y" }} | 
                    {{ booking.jadwal.jam_mulai|time:"H:i" }} - {{ booking.jadwal.jam_selesai|time:"H:i" }}
                </p>
                
                <div class="text-sm text-gray-600 mb-3" id="notes-display-{{ booking.id }}">
                    <strong>Catatan:</strong>
                    {# linebreaksbr agar baris baru tampil #}
                    <p class="mt-1 whitespace-pre-wrap">{{ booking.notes|default:"-"|linebreaksbr }}</p> 
                    {# Tombol Edit Notes #}
                    <button 
                        class="mt-2 text-xs font-semibold text-primary-blue hover:text-blue-700 underline" 
                        onclick="showEditForm({{ booking.id }})">
                        Edit Catatan
                    </button>
                </div>

                <form id="notes-form-{{ booking.id }}" 
                      action="{% url 'update_booking_notes' booking.id %}" 
                      method="POST" 
                      class="mt-2 hidden" {# ≈ edit-notes-form, hidden initially #}
                      onsubmit="submitNotesForm(event, {{ booking.id }})"> 
                    {% csrf_token %}
                    <textarea 
                        name="notes" 
                        rows="3" 
                        class="w-full p-2 border border-gray-300 rounded-md text-sm focus:ring-primary-blue focus:border-primary-blue"
                        >{{ booking.notes }}</textarea>
                    <div class="flex gap-2 justify-end mt-2"> {# ≈ form-actions #}
                         <button 
                            type="button" 
                            class="py-1 px-3 text-xs font-medium bg-gray-200 text-gray-700 rounded hover:bg-gray-300" {# ≈ btn-secondary btn-sm #}
                            onclick="hideEditForm({{ booking.id }})">
                            Batal
                        </button>
                         <button 
                            type="submit" 
                            class="py-1 px-3 text-xs font-medium bg-primary-blue text-white rounded hover:bg-blue-900"> {# ≈ btn-primary btn-sm #}
                            Simpan
                        </button>
                    </div>
                     <span class="text-xs mt-1 block" id="notes-message-{{ booking.id }}"></span> {# notes-message #}
                </form>
            </div>

            <div class="flex flex-col gap-3 items-end pt-1 sm:pt-0 shrink-0"> {# ≈ booking-actions #}
                <form action="{% url 'cancel_booking' booking.id %}" method="POST" onsubmit="return confirm('Anda yakin ingin membatalkan booking ini?')"> 
                     {% csrf_token %}
                     {# ≈ btn btn-danger #}
                     <button type="submit" class="py-2 px-4 text-sm font-semibold bg-primary-orange text-white rounded-lg hover:bg-primary-orange-dark transition">
                        Batalkan
                    </button>
                </form>
                 {# Tombol Merah Misterius (sesuai desain) - bisa dihapus jika tidak perlu #}
                 {# <button class="w-9 h-9 bg-red-600 rounded-lg"></button>  #}
            </div>
        </div>
        {% empty %}
            <p class="text-gray-500 italic">Tidak ada janji temu mendatang.</p>
        {% endfor %}
    </section>

    <section class="mb-12"> {# ≈ booking-section #}
        <h2 class="text-2xl font-bold text-primary-orange mb-6 pb-2 border-b border-gray-300"> {# ≈ section-title #}
            Selesai
        </h2>
        
        {% for booking in completed_bookings %}
         {# ≈ booking-card completed-card #}
        <div class="bg-white rounded-xl shadow-md flex flex-col sm:flex-row items-start gap-4 p-6 mb-6 border-l-4 border-primary-orange opacity-90 relative">
             <div class="flex-grow w-full"> {# ≈ booking-info #}
                <h3 class="text-xl font-bold text-gray-900 mb-1">{{ booking.jadwal.coach.name }}</h3>
                <p class="text-base font-semibold text-primary-blue mb-3">
                    {{ booking.jadwal.tanggal|date:"l, j F Y" }} | 
                    {{ booking.jadwal.jam_mulai|time:"H:i" }} - {{ booking.jadwal.jam_selesai|time:"H:i" }}
                </p>
                {# Tampilkan catatan jika ada #}
                {% if booking.notes %}
                <div class="text-sm text-gray-600 mb-3">
                     <strong>Catatan:</strong>
                     <p class="mt-1 whitespace-pre-wrap">{{ booking.notes|linebreaksbr }}</p>
                </div>
                {% endif %}
            </div>

            <div class="flex gap-3 items-center pt-1 sm:pt-0 shrink-0 sm:flex-col sm:items-end"> {# ≈ booking-actions #}
                {# TODO: Ganti '#' dengan URL view/modal review #}
                <a href="#" class="py-2 px-4 text-sm font-semibold bg-primary-blue text-white rounded-lg hover:bg-blue-900 transition no-underline inline-block"> {# ≈ btn btn-primary #}
                    Review
                </a>
                
                {# TODO: Ganti '#' dengan URL view/modal report #}
                <a href="#" class="w-9 h-9 flex items-center justify-center bg-yellow-100 text-yellow-600 border border-yellow-300 rounded-lg hover:bg-yellow-200 transition" title="Laporkan Sesi Ini"> {# ≈ btn btn-warning (icon) #}
                    <i class="fas fa-exclamation-triangle"></i>
                </a>
            </div>
        </div>
        {% empty %}
            <p class="text-gray-500 italic">Belum ada janji temu yang selesai.</p>
        {% endfor %}
    </section>

</div>
{% endblock %}

{% block content_script %}
<script>
    function showEditForm(bookingId) {
        document.getElementById(`notes-display-${bookingId}`).classList.add('hidden'); // Pakai class 'hidden' Tailwind
        document.getElementById(`notes-form-${bookingId}`).classList.remove('hidden'); // Hapus class 'hidden'
    }

    function hideEditForm(bookingId) {
        document.getElementById(`notes-display-${bookingId}`).classList.remove('hidden');
        document.getElementById(`notes-form-${bookingId}`).classList.add('hidden');
        const messageSpan = document.getElementById(`notes-message-${bookingId}`);
        messageSpan.textContent = ''; 
        messageSpan.classList.remove('text-red-600', 'text-green-600'); // Hapus class warna
    }

    async function submitNotesForm(event, bookingId) {
        event.preventDefault(); 
        const form = event.target;
        const formData = new FormData(form);
        const messageSpan = document.getElementById(`notes-message-${bookingId}`);
        messageSpan.textContent = 'Menyimpan...';
        messageSpan.classList.remove('text-red-600', 'text-green-600'); // Reset warna
        messageSpan.classList.add('text-gray-500'); // Warna loading

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest', 
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken') // Eksplisit kirim token
                }
            });

            const result = await response.json(); 

            if (response.ok && result.success) {
                const newNotes = formData.get('notes');
                const displayParagraph = document.querySelector(`#notes-display-${bookingId} p`);
                // Update teks dan handle line breaks (ganti \n jadi <br>)
                displayParagraph.innerHTML = newNotes ? newNotes.replace(/\r?\n/g, '<br>') : '-'; 
                
                messageSpan.textContent = 'Berhasil disimpan!';
                messageSpan.classList.remove('text-gray-500', 'text-red-600');
                messageSpan.classList.add('text-green-600'); // Warna sukses
                setTimeout(() => hideEditForm(bookingId), 1500); 
            } else {
                 messageSpan.textContent = `Gagal: ${result.error || response.statusText || 'Terjadi kesalahan'}`;
                 messageSpan.classList.remove('text-gray-500', 'text-green-600');
                 messageSpan.classList.add('text-red-600'); // Warna error
            }
        } catch (error) {
            console.error('Error updating notes:', error);
            messageSpan.textContent = 'Error: Tidak dapat menghubungi server.';
            messageSpan.classList.remove('text-gray-500', 'text-green-600');
            messageSpan.classList.add('text-red-600'); // Warna error
        }
    }
</script>
{% endblock %}