{% extends 'base.html' %}
{% load static %}

{% block title %}Janji Temu Anda{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto py-10 px-6 bg-white rounded-2xl shadow-sm mt-8 border border-gray-200">

  <h1 class="text-4xl font-bold text-[#002B7F] mb-10 border-b border-gray-300 pb-3">
    Janji Temu Anda
  </h1>

  <section class="mb-12">
    <h2 class="text-2xl font-bold text-[#E64500] mb-6">Mendatang</h2>

    {% for booking in upcoming_bookings %}
    <div class="border-4 border-[#002B7F] rounded-xl p-6 mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">

      <div class="flex-1">
        <h3 class="text-lg font-bold text-[#002B7F]">{{ booking.jadwal.coach.name }}</h3>
        <p class="font-semibold text-[#002B7F] mt-1">
          {{ booking.jadwal.tanggal|date:"l, j F Y" }} | {{ booking.jadwal.jam_mulai|time:"H:i" }} – {{ booking.jadwal.jam_selesai|time:"H:i" }}
        </p>
        <p class="text-gray-700 text-sm mt-2">
          Fokus latihan: {{ booking.focus|default:"-" }}
        </p>

        <div id="notes-display-{{ booking.id }}" class="mt-3">
          <p class="text-sm text-gray-700 whitespace-pre-wrap">{{ booking.notes|default:"-" }}</p>
          <button
            class="mt-2 text-xs font-semibold text-[#002B7F] hover:underline"
            onclick="showEditForm({{ booking.id }})"
          >
            Edit Catatan
          </button>
        </div>

        <form id="notes-form-{{ booking.id }}"
              action="{% url 'update_booking_notes' booking.id %}"
              method="POST"
              class="hidden mt-2"
              onsubmit="submitNotesForm(event, {{ booking.id }})">
          {% csrf_token %}
          <textarea
            name="notes"
            rows="3"
            class="w-full p-2 border border-gray-300 rounded-md text-sm focus:ring-[#002B7F] focus:border-[#002B7F]"
          >{{ booking.notes }}</textarea>
          <div class="flex justify-end gap-2 mt-2">
            <button type="button"
              class="py-1 px-3 text-xs font-medium bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
              onclick="hideEditForm({{ booking.id }})">
              Batal
            </button>
            <button type="submit"
              class="py-1 px-3 text-xs font-medium bg-[#002B7F] text-white rounded hover:bg-[#001C57]">
              Simpan
            </button>
          </div>
          <span class="text-xs mt-1 block" id="notes-message-{{ booking.id }}"></span>
        </form>
      </div>

      <form action="{% url 'cancel_booking' booking.id %}" method="POST"
            onsubmit="return confirm('Anda yakin ingin membatalkan booking ini?')">
        {% csrf_token %}
        <button type="submit"
          class="py-2 px-5 text-sm font-semibold bg-[#E64500] text-white rounded-lg hover:bg-[#c43a00] transition">
          Batalkan
        </button>
      </form>
    </div>
    {% empty %}
    <p class="text-gray-500 italic">Tidak ada janji temu mendatang.</p>
    {% endfor %}
  </section>

  <section>
    <h2 class="text-2xl font-bold text-[#E64500] mb-6">Selesai</h2>

    {% for booking in completed_bookings %}
    <div class="border-4 border-[#E64500] rounded-xl p-6 mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">

      <div class="flex-1">
        <h3 class="text-lg font-bold text-[#E64500]">{{ booking.jadwal.coach.name }}</h3>
        <p class="font-semibold text-[#002B7F] mt-1">
          {{ booking.jadwal.tanggal|date:"l, j F Y" }} | {{ booking.jadwal.jam_mulai|time:"H:i" }} – {{ booking.jadwal.jam_selesai|time:"H:i" }}
        </p>
      </div>

      <div class="flex items-center gap-3">
      {#TODO report coach#}
        <a href="#" class="flex items-center justify-center w-8 h-8 bg-[#E64500] text-white rounded-lg">
          <i class="fas fa-exclamation-triangle text-sm"></i>
        </a>
      {#TODO review coach#}
        <a href="#"
          class="py-2 px-5 text-sm font-semibold bg-[#002B7F] text-white rounded-lg hover:bg-[#001C57] transition">
          Review
        </a>
      </div>
    </div>
    {% empty %}
    <p class="text-gray-500 italic">Belum ada janji temu yang selesai.</p>
    {% endfor %}
  </section>
</div>
{% endblock %}

{% block content_script %}
<script>
  function showEditForm(bookingId) {
    document.getElementById(`notes-display-${bookingId}`).classList.add('hidden');
    document.getElementById(`notes-form-${bookingId}`).classList.remove('hidden');
  }

  function hideEditForm(bookingId) {
    document.getElementById(`notes-display-${bookingId}`).classList.remove('hidden');
    document.getElementById(`notes-form-${bookingId}`).classList.add('hidden');
    const msg = document.getElementById(`notes-message-${bookingId}`);
    msg.textContent = '';
  }

  async function submitNotesForm(event, bookingId) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const msg = document.getElementById(`notes-message-${bookingId}`);
    msg.textContent = 'Menyimpan...';
    msg.className = 'text-xs text-gray-500';

    try {
      const res = await fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': formData.get('csrfmiddlewaretoken') }
      });
      const result = await res.json();

      if (res.ok && result.success) {
        const newNotes = formData.get('notes');
        document.querySelector(`#notes-display-${bookingId} p`).innerHTML = newNotes ? newNotes.replace(/\r?\n/g, '<br>') : '-';
        msg.textContent = 'Berhasil disimpan!';
        msg.className = 'text-xs text-green-600';
        setTimeout(() => hideEditForm(bookingId), 1500);
      } else {
        msg.textContent = result.error || 'Gagal menyimpan.';
        msg.className = 'text-xs text-red-600';
      }
    } catch (e) {
      msg.textContent = 'Terjadi kesalahan server.';
      msg.className = 'text-xs text-red-600';
    }
  }
</script>
{% endblock %}
