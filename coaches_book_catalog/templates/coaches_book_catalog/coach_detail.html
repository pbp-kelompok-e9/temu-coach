{% extends 'base.html' %}
{% load static %}

{% block title %}Detail {{ coach.name }}{% endblock %}

{% block content %}
<div class="flex flex-wrap gap-8 my-8 mx-auto max-w-7xl px-4 items-start">
    
    <aside class="flex-1 min-w-[320px] order-1 bg-white border border-gray-200 rounded-xl shadow-sm p-8">
        <div class="w-45 h-45 mx-auto mb-6 rounded-full overflow-hidden bg-gray-100 border-4 border-white shadow-md">
             {% if coach.foto %}
                <img src="{{ coach.foto.url }}" alt="{{ coach.name }}" class="w-full h-full object-cover">
            {% else %}
                <img src="{% static 'images/default_avatar.png' %}" alt="Default Avatar" class="w-full h-full object-cover">
            {% endif %}
        </div>
        
        <h1 class="text-3xl font-bold mb-1 text-gray-900 text-center">{{ coach.name }}</h1>
        <p class="text-base text-gray-500 text-center mb-6">
            {{ coach.citizenship }} | {{ coach.age }} years old
        </p>
        
        <div class="h-px bg-gray-200 my-6"></div>
        
        <ul class="list-none p-0 m-0">
            <li class="flex items-center gap-3 py-2.5 text-gray-600 text-sm leading-relaxed border-b border-gray-100">
                <i class="fas fa-shield-alt w-[18px] text-center text-[#DE3400] text-lg"></i> 
                <span class="font-normal">Klub: <strong class="font-semibold text-gray-900">{{ coach.club|default:"-" }}</strong></span>
            </li>
            <li class="flex items-center gap-3 py-2.5 text-gray-600 text-sm leading-relaxed border-b border-gray-100">
                <i class="fas fa-futbol w-[18px] text-center text-[#DE3400] text-lg"></i> 
                <span class="font-normal">Formasi: <strong class="font-semibold text-gray-900">{{ coach.preffered_formation|default:"-" }}</strong></span>
            </li>
            <li class="flex items-center gap-3 py-2.5 text-gray-600 text-sm leading-relaxed border-b border-gray-100">
                <i class="fas fa-id-badge w-[18px] text-center text-[#DE3400] text-lg"></i> 
                <span class="font-normal">Lisensi: <strong class="font-semibold text-gray-900">{{ coach.license|default:"-" }}</strong></span>
            </li>
             <li class="flex items-center gap-3 py-2.5 text-gray-600 text-sm leading-relaxed">
                <i class="fas fa-clock w-[18px] text-center text-[#DE3400] text-lg"></i> 
                <span class="font-normal">Avg Term: <strong class="font-semibold text-gray-900">{{ coach.average_term_as_coach|default:"-" }} Tahun</strong></span>
            </li>
        </ul>
        
        <div class="h-px bg-gray-200 my-6"></div>
        
        <div class="mt-6">
             <h3 class="text-lg font-semibold text-gray-900 mb-2">Deskripsi</h3>
             <p class="text-gray-600 leading-relaxed text-sm m-0">{{ coach.description|default:"Tidak ada deskripsi." }}</p>
        </div>

        <a href="{% url 'show_catalog' %}" class="inline-block mt-6 px-6 py-3 bg-[#DE3400] text-white no-underline rounded-lg font-semibold text-sm text-center transition-colors duration-200 hover:bg-[#c42e00]">Kembali</a>
    </aside>

    <main class="flex-[1.2] min-w-[320px] order-2 bg-white border border-gray-200 rounded-xl shadow-sm p-8">
        <div class="mb-6">
            <h2 class="text-2xl font-bold mb-6 text-[#003E85]">Pilih Jadwal Booking</h2>
        </div>

        <div class="mb-6 border-b border-gray-100 pb-6">
            <div class="flex justify-between items-center mb-4">
                <div class="text-lg font-semibold text-gray-900" id="currentMonth"></div>
                <div class="flex gap-2">
                    <button class="bg-transparent border-none cursor-pointer text-[#003E85] p-2 hover:bg-gray-50 rounded" id="prevMonth" aria-label="Previous Month">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="bg-transparent border-none cursor-pointer text-[#003E85] p-2 hover:bg-gray-50 rounded" id="nextMonth" aria-label="Next Month">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="grid grid-cols-7 gap-1" id="calendarGrid">
                <div class="text-center text-xs font-semibold text-gray-400 pb-2">Min</div>
                <div class="text-center text-xs font-semibold text-gray-400 pb-2">Sen</div>
                <div class="text-center text-xs font-semibold text-gray-400 pb-2">Sel</div>
                <div class="text-center text-xs font-semibold text-gray-400 pb-2">Rab</div>
                <div class="text-center text-xs font-semibold text-gray-400 pb-2">Kam</div>
                <div class="text-center text-xs font-semibold text-gray-400 pb-2">Jum</div>
                <div class="text-center text-xs font-semibold text-gray-400 pb-2">Sab</div>
            </div>
        </div>

        <div class="pt-6">
            <div class="text-lg font-bold mb-4 text-[#003E85]" id="selectedDateDisplay" style="display: none;">Pilih sesi</div>
            
            <div id="noDateSelected" class="text-center py-8 text-gray-400">
                <p>Pilih tanggal di kalender untuk melihat slot waktu yang tersedia.</p>
            </div>
            
            <div id="timeSlotsGrid" class="grid grid-cols-3 gap-3 mb-8 max-md:grid-cols-2 max-sm:grid-cols-1" style="display: none;"></div>

             <form id="booking-form" method="POST" action="" style="display: none;"> 
                {% csrf_token %}
                <input type="hidden" name="jadwal_id" id="selected-jadwal-id" value=""> 
                <div class="mt-6 mb-6">
                    <label for="booking-notes" class="block text-sm font-semibold text-gray-600 mb-2">Catatan untuk sesi ini (opsional):</label>
                    <textarea id="booking-notes" name="notes" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm leading-relaxed resize-y box-border min-h-[80px] focus:outline-none focus:border-[#003E85] focus:ring-4 focus:ring-[#003E85]/10" placeholder="Contoh: Fokus pada latihan passing..."></textarea>
                </div>
                <div class="pt-6 border-t border-gray-100">
                    <div class="text-3xl font-bold text-gray-900 mb-4 text-center">Rp {{ coach.rate_per_session|floatformat:0 }}</div>
                    <button type="submit" class="w-full px-4 py-4 bg-[#DE3400] text-white border-none rounded-lg text-lg font-bold cursor-pointer transition-all duration-200 hover:bg-[#c42e00] hover:-translate-y-0.5 hover:shadow-lg disabled:bg-red-200 disabled:text-red-400 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none" id="bookSessionBtn" disabled>
                        Book Session
                    </button>
                </div>
            </form>
        </div>
    </main>

    <section class="w-full order-3 mt-8 bg-white border border-gray-200 rounded-xl shadow-sm p-8">
        <h2 class="text-2xl font-bold text-[#003E85] mb-6">Reviews ({{ total_reviews }})</h2>
        <div class="flex gap-6 overflow-x-auto pb-6 snap-x snap-mandatory [-ms-overflow-style:none] [scrollbar-width:none] [&::-webkit-scrollbar]:hidden">
            {% if reviews %}
                {% for review in reviews %}
                    <div class="flex-[0_0_300px] snap-start bg-white border border-gray-200 rounded-xl shadow-sm p-6">
                        <div class="text-yellow-400 mb-2">
                            {% for i in "12345" %}
                                {% if forloop.counter <= review.rate %}
                                    <i class="fas fa-star mr-0.5"></i>
                                {% else %}
                                    <i class="far fa-star mr-0.5"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <div class="font-semibold text-[#2c3e50] mb-2">{{ review.user.username }}</div>
                        <p class="text-[#34495e] text-sm leading-relaxed mb-2">{{ review.review }}</p>
                        <div class="text-[#7f8c8d] text-xs">{{ review.created_at|date:"d M Y" }}</div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="flex-[0_0_300px] snap-start bg-white border border-gray-200 rounded-xl shadow-sm p-6">
                    <p class="text-[#34495e] text-sm leading-relaxed mb-2">Belum ada review.</p>
                </div>
            {% endif %}
        </div>

        <div class="mt-8 text-center">
            <div class="flex items-center justify-center gap-4">
                <span class="text-3xl font-bold text-[#2c3e50]">{{ avg_rating }}</span>
                <div class="text-yellow-400 mb-2">
                    {% for i in "12345" %}
                        {% if forloop.counter <= avg_rating %}
                            <i class="fas fa-star mr-0.5"></i>
                        {% else %}
                            <i class="far fa-star mr-0.5"></i>
                        {% endif %}
                    {% endfor %}
                </div>
                <span class="text-[#7f8c8d] text-sm">({{ total_reviews }} reviews)</span>
            </div>
        </div>
    </section>

</div>

<script>
    const scheduleData = {
        {% for tanggal, jadwal_list in grouped_schedules.items %}
        "{{ tanggal|date:'Y-m-d' }}": [
            {% for jadwal in jadwal_list %}
            {
                id: {{ jadwal.id }},
                start: "{{ jadwal.jam_mulai|time:'H:i' }}",
                end: "{{ jadwal.jam_selesai|time:'H:i' }}"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]{% if not forloop.last %},{% endif %}
        {% endfor %}
    };

    let currentDate = new Date();
    let selectedDate = null; 
    let selectedSlotId = null;

    const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    const calendarGrid = document.getElementById('calendarGrid');
    const currentMonthDisplay = document.getElementById('currentMonth');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    const selectedDateDisplay = document.getElementById('selectedDateDisplay');
    const timeSlotsGrid = document.getElementById('timeSlotsGrid');
    const noDateSelectedMsg = document.getElementById('noDateSelected');
    const bookingForm = document.getElementById('booking-form'); 
    const hiddenJadwalInput = document.getElementById('selected-jadwal-id');
    const bookSessionButton = document.getElementById('bookSessionBtn'); 

    function initializeCalendar() {
        const availableDates = Object.keys(scheduleData);
        if (availableDates.length > 0) {
            availableDates.sort();
            const firstAvailableDate = new Date(availableDates[0] + 'T00:00:00');
            currentDate = new Date(firstAvailableDate.getFullYear(), firstAvailableDate.getMonth(), 1);
        } else {
             const today = new Date();
             currentDate = new Date(today.getFullYear(), today.getMonth(), 1);
        }
        renderCalendar();
        updateBookButtonState(); 
    }

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        currentMonthDisplay.textContent = `${monthNames[month]} ${year}`;
        
        const firstDayOfMonth = new Date(year, month, 1).getDay(); 
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        calendarGrid.querySelectorAll('.calendar-day').forEach(day => day.remove()); 
        
        for (let i = 0; i < firstDayOfMonth; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day invisible';
            calendarGrid.appendChild(emptyDay);
        }
        
        const today = new Date(); 
        today.setHours(0, 0, 0, 0);
        
        for (let day = 1; day <= daysInMonth; day++) {
            const dayDate = new Date(year, month, day); 
            dayDate.setHours(0, 0, 0, 0);
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day aspect-square flex items-center justify-center rounded-full text-sm cursor-pointer transition-all duration-200 border-2 border-transparent bg-white text-gray-600';
            dayCell.textContent = day;
            dayCell.dataset.date = dateStr;
            
            const hasSlots = scheduleData[dateStr] && scheduleData[dateStr].length > 0;
            const isPast = dayDate < today;
            
            if (isPast) {
                dayCell.className += ' text-gray-400 cursor-not-allowed line-through opacity-60';
            } else if (hasSlots) {
                dayCell.className += ' font-semibold text-[#003E85] relative hover:bg-[#EBF4FF]';
                dayCell.innerHTML = `${day}<span class="absolute bottom-1 left-1/2 -translate-x-1/2 w-1.5 h-1.5 bg-[#003E85] rounded-full"></span>`;
                dayCell.addEventListener('click', () => handleDateClick(dateStr, dayDate));
            } else {
                dayCell.className += ' text-gray-300 cursor-not-allowed';
            }
            
            if (selectedDate === dateStr) { 
                dayCell.className = dayCell.className.replace('bg-white', 'bg-[#003E85]');
                dayCell.className = dayCell.className.replace('text-[#003E85]', 'text-white');
                dayCell.className = dayCell.className.replace('border-transparent', 'border-[#003E85]');
                dayCell.className += ' font-bold';
                if (hasSlots) {
                    dayCell.innerHTML = `${day}<span class="absolute bottom-1 left-1/2 -translate-x-1/2 w-1.5 h-1.5 bg-white rounded-full"></span>`;
                }
            }
            
            calendarGrid.appendChild(dayCell);
        }
    }

    function handleDateClick(dateStr, dateObj) {
        selectedDate = dateStr;
        selectedSlotId = null; 
        renderCalendar(); 
        displayTimeSlots(dateStr, dateObj);
        updateBookButtonState();
    }

    function displayTimeSlots(dateStr, dateObj) {
        const slots = scheduleData[dateStr] || [];
        
        if (selectedDate) {
            selectedDateDisplay.textContent = `Pilih sesi untuk ${dateObj.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' })}`;
            selectedDateDisplay.style.display = 'block';
            noDateSelectedMsg.style.display = 'none';

            if (slots.length > 0) {
                timeSlotsGrid.innerHTML = ''; 
                slots.forEach(slot => {
                    const button = document.createElement('button');
                    button.type = 'button'; 
                    button.className = 'py-3.5 px-4 bg-[#DE3400] border-none rounded-lg cursor-pointer transition-all duration-200 text-sm font-semibold text-white text-center hover:bg-[#c42e00] hover:-translate-y-0.5 hover:shadow-md active:translate-y-0 active:shadow-none';
                    button.textContent = `${slot.start} - ${slot.end}`;
                    button.dataset.jadwalId = slot.id; 

                    button.addEventListener('click', () => handleSlotClick(button, slot.id)); 
                    
                    timeSlotsGrid.appendChild(button);
                });
                timeSlotsGrid.style.display = 'grid';
                bookingForm.style.display = 'block'; 
            } else {
                 timeSlotsGrid.innerHTML = '<p class="text-center py-8 text-gray-400 col-span-3">Tidak ada slot tersedia.</p>';
                 timeSlotsGrid.style.display = 'grid'; 
                 bookingForm.style.display = 'none'; 
                 selectedSlotId = null; 
            }

        } else {
            selectedDateDisplay.style.display = 'none';
            noDateSelectedMsg.style.display = 'block';
            timeSlotsGrid.style.display = 'none';
            bookingForm.style.display = 'none';
            selectedSlotId = null;
        }
        updateBookButtonState(); 
    }

    function handleSlotClick(clickedButton, jadwalId) {
        timeSlotsGrid.querySelectorAll('button').forEach(btn => {
            btn.className = 'py-3.5 px-4 bg-[#DE3400] border-none rounded-lg cursor-pointer transition-all duration-200 text-sm font-semibold text-white text-center hover:bg-[#c42e00] hover:-translate-y-0.5 hover:shadow-md active:translate-y-0 active:shadow-none';
        });

        clickedButton.className = 'py-3.5 px-4 bg-[#003E85] border-none rounded-lg cursor-pointer transition-all duration-200 text-sm font-semibold text-white text-center shadow-[0_0_0_3px_rgba(0,62,133,0.3)] scale-[1.03] hover:bg-[#002a5c]';
        
        selectedSlotId = jadwalId;
        
        hiddenJadwalInput.value = selectedSlotId;
        
        bookingForm.action = "{% url 'book_coach' 0 %}".replace('0', selectedSlotId);

        updateBookButtonState();
    }

    function updateBookButtonState() {
        if (selectedDate && selectedSlotId) {
            bookSessionButton.disabled = false;
        } else {
            bookSessionButton.disabled = true;
        }
    }

    prevMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        selectedDate = null; 
        selectedSlotId = null; 
        renderCalendar();
        displayTimeSlots(null, null);
    });

    nextMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        selectedDate = null; 
        selectedSlotId = null; 
        renderCalendar();
        displayTimeSlots(null, null); 
    });

    initializeCalendar();
</script>
{% endblock %}