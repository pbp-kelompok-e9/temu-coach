{% load static %}
<!-- modal_schedule.html -->
<div>
  

  <!-- Modal -->
  <div 
    id="crudModal" 
    class="hidden fixed inset-0 z-50 bg-black/60 flex justify-center items-center">
    
    <div class="bg-white rounded-xl shadow-lg w-11/12 max-w-md flex flex-col max-h-[90vh] overflow-hidden">
      <!-- Header -->
      <div class="flex justify-between items-center border-b px-4 py-3 bg-gray-50">
        <h3 class="text-lg font-semibold text-gray-800">Tambahkan Jadwal</h3>
        <button 
          onclick="hideModal()" 
          class="text-gray-500 hover:text-gray-700 text-xl font-bold">
          Ã—
        </button>
      </div>

      <!-- Body -->
      <form id="jadwalForm" method="POST" class="flex-1 overflow-y-auto px-5 py-4 space-y-4">
        {% csrf_token %}
        <div>
          <label for="tanggal" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
          <input 
            type="date" 
            id="tanggal" 
            name="tanggal" 
            required
            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div>
          <label for="jam_mulai" class="block text-sm font-medium text-gray-700 mb-1">Jam Mulai</label>
          <input 
            type="time" 
            id="jam_mulai" 
            name="jam_mulai" 
            required
            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div>
          <label for="jam_selesai" class="block text-sm font-medium text-gray-700 mb-1">Jam Selesai</label>
          <input 
            type="time" 
            id="jam_selesai" 
            name="jam_selesai" 
            required
            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
      </form>

      <!-- Footer -->
      <div class="flex justify-end gap-3 border-t px-5 py-3 bg-gray-50">
        <button 
          onclick="hideModal()" 
          class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold px-4 py-2 rounded-lg transition">
          Batal
        </button>
        <button 
          type="submit" 
          form="jadwalForm"
          class="bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg transition">
          Simpan
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  const modal = document.getElementById('crudModal');

  function showModal() {
    modal.classList.remove('hidden');
  }

  function hideModal() {
    modal.classList.add('hidden');
  }

  window.addEventListener('click', (e) => {
    if (e.target === modal) hideModal();
  });

  document.getElementById('jadwalForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    try {
      const response = await fetch("{% url 'add_schedule' %}", {
        method: "POST",
        headers: {
          'X-Requested-With': 'XMLHttpRequest', // biar view tahu ini AJAX
        },
        body: formData,
      });

      if (!response.ok) throw new Error('Gagal menyimpan data');

      const result = await response.json(); // pastikan view return JsonResponse
      console.log('Response:', result);

      showToast("Berhasil!", "Jadwal berhasil ditambahkan!", "success");
      this.reset();
      hideModal();

      // opsional: update jadwal list tanpa reload
      // kamu bisa fetch ulang daftar jadwal di sini

      const jadwalList = document.getElementById("jadwalList");
      const jadwalHTML = `
        <div id="jadwal-${result.id}" class="border-2 border-blue-800 rounded-xl p-4 flex justify-between items-start">
          <div>
            <p class="font-bold text-lg text-blue-900">${result.tanggal}, ${result.jam_mulai} - ${result.jam_selesai}</p>
            <p class="text-gray-700"><span class="font-semibold text-green-600">Tersedia</span></p>
          </div>
          <button class="bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg transition delete-jadwal-btn" data-id="${result.id}">
            Batalkan
          </button>
        </div>
      `;
      jadwalList.insertAdjacentHTML('beforeend', jadwalHTML);

    } catch (error) {
      console.error(error);
      showToast("Error", "Terjadi kesalahan saat menyimpan jadwal.", "error");
    }
  });

    document.addEventListener('click', async function(e) {
    if (e.target.classList.contains('delete-jadwal-btn')) {
      const id = e.target.dataset.id;
      if (!confirm('Yakin ingin menghapus jadwal ini?')) return;

      try {
        const response = await fetch(`/delete_schedule/${id}/`, {
          method: "DELETE",
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest',
          },
        });

        if (!response.ok) throw new Error('Gagal menghapus jadwal');
        document.getElementById(`jadwal-${id}`).remove();
      } catch (err) {
        console.error(err);
        showToast("Error", "Gagal menghapus jadwal", "error");
      }
    }
  });

</script>
{% include 'toast.html' %}

